<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <link href="/resources/main.css" rel="stylesheet">
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Пример веб-страницы</title>
</head>
<body>
<center><h1 class="ribbon"><strong class="ribbon-content">Система управления баллами по АИП для студентов УИР</strong></h1></center>


<input id="spterm" type="text" name="spterm" placeholder="Что искать?"><br />
<div id="spresult">&nbsp;</div>

    <a href="/login" target="_blank" class="great_btn">
      <right> <button>Вход для преподавателя</button></right>
    </a>

<center><table id="all-student-table" class="features-table">
    <tr>
        <th>Имя и Фамилия студента</th>
        <th>Количество баллов</th>
        <th>Количество пропусков по уважительной причине</th>
        <th>Количество пропусков по неуважительной причине</th>
    </tr>
</table></center>

<script type="text/javascript">
    var x = new XMLHttpRequest();
    x.open("GET", "/student/all", true);
    x.onload = function (){
        var parsedStudents = JSON.parse(this.responseText);
        var studentsTable = document.getElementById('all-student-table');
        parsedStudents.forEach(function(item)  {
            var fullNameElement = document.createElement('td');
            fullNameElement.innerHTML = '<p>' + item['fullName'] + '</p>';
            var estimateElement = document.createElement('td');
            var estimateList = item['estimate'];
            var estimateValue = 0;
            estimateList.forEach(function(item, i, arr) {
                estimateValue+=item.estimate;
            });
            estimateElement.innerHTML = '<p>' + estimateValue + '</p>';
            var respectElement = document.createElement('td');
            var notRespectElement = document.createElement('td');
            var respectList = item['dateList'];
            var respectValue = 0;
            var notRespectValue = 0;
            respectList.forEach(function(item, i, arr) {
                respectValue+=item.respectCause;
                notRespectValue+=item.notRespectCause;
            });
            respectElement.innerHTML = '<p>' + respectValue + '</p>';
            notRespectElement.innerHTML = '<p>' + notRespectValue + '</p>';
            var elementContainer = document.createElement('tr');
            elementContainer.appendChild(fullNameElement);
            elementContainer.appendChild(estimateElement);
            elementContainer.appendChild(respectElement);
            elementContainer.appendChild(notRespectElement);
            studentsTable.appendChild(elementContainer);
        });
    }
    x.send(null);

    jQuery(document).ready(function(){
        var minlen = 3; // минимальная длина слова
        var paddingtop = 30; // отступ сверху при прокрутке
        var scrollspeed = 200; // время прокрутки
        var keyint = 1000; // интервал между нажатиями клавиш
        var term = '';
        var n = 0;
        var time_keyup = 0;
        var time_search = 0;

        jQuery('body').delegate('#spgo', 'click', function(){
            jQuery('body,html').animate({scrollTop: jQuery('span.highlight:first').offset().top-paddingtop}, scrollspeed); // переход к первому фрагменту
        });

        function dosearch() {
            term = jQuery('#spterm').val();
            jQuery('span.highlight').each(function(){ //удаляем старую подсветку
                jQuery(this).after(jQuery(this).html()).remove();
            });
            var t = '';
            jQuery('div#all-student-table').each(function(){ // в селекторе задаем область поиска
                jQuery(this).html(jQuery(this).html().replace(new RegExp(term, 'ig'), '<span class="highlight">$&</span>')); // выделяем найденные фрагменты
                n = jQuery('span.highlight').length; // количество найденных фрагментов
                console.log('n = '+n);
                if (n==0)
                    jQuery('#spresult').html('Ничего не найдено');
                else
                    jQuery('#spresult').html('Результатов: '+n+'. <span class="splink" id="spgo">Перейти</span>');
                if (n>1) // если больше одного фрагмента, то добавляем переход между ними
                {
                    var i = 0;
                    jQuery('span.highlight').each(function(i){
                        jQuery(this).attr('n', i++); // нумеруем фрагменты, более простого способа искать следующий элемент не нашел
                    });
                    jQuery('span.highlight').not(':last').attr({title: 'Нажмите, чтобы перейти к следующему фрагменту'}).click(function(){ // всем фрагментам, кроме последнего, добавляем подсказку
                        jQuery('body,html').animate({scrollTop: jQuery('span.highlight:gt('+jQuery(this).attr('n')+'):first').offset().top-paddingtop}, scrollspeed); // переход к следующему фрагменту
                    });
                    jQuery('span.highlight:last').attr({title: 'Нажмите, чтобы вернуться к форме поиска'}).click(function(){
                        jQuery('body,html').animate({scrollTop: jQuery('#spterm').offset().top-paddingtop}, scrollspeed); // переход к форме поиска
                    });
                }
            });
        }

        jQuery('#spterm').keyup(function(){
            var d1 = new Date();
            time_keyup = d1.getTime();
            if (jQuery('#spterm').val()!=term) // проверяем, изменилась ли строка
                if (jQuery('#spterm').val().length>=minlen) { // проверяем длину строки
                    setTimeout(function(){ // ждем следующего нажатия
                        var d2 = new Date();
                        time_search = d2.getTime();
                        if (time_search-time_keyup>=keyint) // проверяем интервал между нажатиями
                            dosearch(); // если все в порядке, приступаем к поиску
                    }, keyint);
                }
                else
                    jQuery('#spresult').html('&nbsp'); // если строка короткая, убираем текст из DIVа с результатом
        });

        if (window.location.hash!="") // бонус
        {
            var t = window.location.hash.substr(1, 50); // вырезаем текст
            jQuery('#spterm').val(t).keyup(); // вставляем его в форму поиска
            jQuery('#spgo').click(); // переходим к первому фрагменту
        }
    });

</script>

</body>
</html>